
# Iptables

## General informations

| tabella  | catene                                                                                                                                                                                                                                                                                                                                | obiettivi                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `filter` | `INPUT`: regole per i pacchetti destinati ad un processo locale<br>`OUTPUT`: regole per i pacchetti diretti verso l'esterno<br>`FORWARD`: regole per i pacchetti in transito                                                                                                                                                          | `DROP`: scarta il pacchetto (silenziosamente)<br> `REJECT`: scarta il pacchetto inviando un messaggio al mittente<br> `ACCEPT`: autorizza il pacchetto ad attraversare il firewall<br> `QUEUE`: rende il pacchetto disponibile per elaborazioni in user space<br> `LOG`: effettua registrazione delle informazioni relative a pacchetti conformi alle regole specificate<br>`<CATENA_UTENTE>`: utile per organizzare logicamente le regole |
| `nat`    | `PREROUTING`: consente manipolazioni sull'indirizzo di destinazione (DNAT) dei pacchetti provenienti dall'esterno<br>`OUTPUT`: consente manipolazioni sull'indirizzo di destinazione (DNAT) dei pacchetti generati localmente<br>`POSTROUTING`: consente manipolazioni sugli indirizzi sorgente (SNAT) di tutti i pacchetti in uscita | `SNAT`: modifica indirizzo IP e porta sorgenti dei pacchetti in uscita<br>`MASQUERADE`: sostituisce l'indirizzo IP sorgente di un pacchetto con quello dell'interfaccia di rete a cui è destinato<br>`DNAT`: modifica l'indirizzo IP e la porta destinazione di un pacchetto in ingresso<br>`REDIRECT`: sostituisce l'indirizzo IP di destinazione di un pacchetto con quello dell'host che si occupa del NAT                              |


## Firewalling

| comando                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | funzione                                                                                                                                                                                                                                                | opzioni                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `iptables [-t <table>] -P <chain> {ACCEPT, DROP}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | imposta la policy di una catena della tabella (se non specificata il default è `filter`)                                                                                                                                                                | `-P`: `policy`<br>`-N <user_chain>`: nuova catena definita dall'utente (`new`)<br>`-L`: mostra le catene della tabella e le regole di ogni catena (`list`)<br>`-D <chain> <idx>`: elimina la regola numero `<idx>` dalla catena `<chain>` (`delete`, si conta da 1)<br>`-F [<chain>]`: elimina tutte le regole da una catena (`flush`, se non specificata elimina tutte le regole della tabella), non cambia la policy di default<br>`-X <user_chain>`: elimina una catena creata con `-N` |
| `iptables [-t <table>] -A <chain> <evaluation_expression> -j <action> [<options>]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | aggiunge una regola a una catena della tabella (se non specificata il default è `filter`)                                                                                                                                                               | `-A`: `append`<br>`-j`: `jump`<br>`-p`: `protocol`<br>`-i`: `input`<br>`-o`: `output`<br>`-m`: `module`<br>`-d`: `destination IP`<br>`-s`: `source IP`<br>`--dport`: `destination port`<br>`--sport`: `source port`<br>`!`: `not`<br>`--state {NEW,ESTABLISHED,RELATED}`: stato della comunicazione TCP<br>`--to-source <IP_address>`: da usare con `SNAT`<br>`--to-destination <IP_address>`: da usare con `DNAT`                                                                         |
| `iptables-save > <filename>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | salva la configurazione del firewall su `<filename>`                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `iptables -t <table> -L -v -n`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | visualizza le regole incluse nelle catene appartenenti alla tabella `<table>` e le loro policy di default                                                                                                                                               | `-n`: senza provare ad eseguire il reverse lookup degli indirizzi IP                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `iptables -A INPUT -i <iface_A> -p <protocol> --sport 68 --dport 67 -j ACCEPT`<br><br>`iptables -A OUTPUT -o <iface_A> -p <protocol> --sport 67 --dport 68 -j ACCEPT`<br><br>`iptables -A OUTPUT -o <iface_B> -p <protocol> -s <iface_A_IP> --sport 67 -d <dhcp_IP> --dport 67 -m state --state NEW,ESTABLISHED -j ACCEPT`<br><br>`iptables -A INPUT -i <iface_B> -p <protocol> -s <dhcp_IP> --sport 67 -d <iface_A_IP> --dport 67 -m state --state ESTABLISHED -j ACCEPT`                                                                                     | Consentire comunicazioni fra DHCP server, nodi esterni e DHCP relay in esecuzione su un firewall (`<protocol>` di norma è `udp`, `68` è la porta del client e `67` quella del server), se DHCP server e firewall coincidono bastano i primi due comandi |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `iptables -A {FORWARD, INPUT} -p {udp, tcp} --dport <service_port> -i <iface_A> [-o iface_B>] -s {<subnet>, <host>} [-d <dest_IP>] -m state --state NEW, ESTABLISHED -j ACCEPT`<br><br>`iptables -A {FORWARD, OUTPUT} -p {udp, tcp} --sport <service_port> -o <iface_A> [-i <iface_B>] -d {<subnet>, <host>} [-s <dest_IP>] -m state --state ESTABLISHED -j ACCEPT`<br>                                                                                                                                                                                        | Consentire comunicazioni (richieste e risposte) relative al traffico di un servizio (roba tra `[]` solo se firewall e dns server non coincidono)                                                                                                        | `-p udp, <service_port> 53, -d <dns_server>`: DNS<br>`-A INPUT/OUTPUT, -p tcp, <service_port> ssh` = ssh                                                                                                                                                                                                                                                                                                                                                                                   |
| `iptables -A FORWARD -p tcp --dport ftp -i <iface_A> -o iface_B> -d <ftp_server> -m state --state NEW,ESTABLISHED -j ACCEPT`<br><br>`iptables -A FORWARD -p tcp --sport ftp -o <iface_A> -i <iface_B> -s <ftp_server> -m state --state ESTABLISHED -j ACCEPT`<br><br>`iptables -A FORWARD -p {udp, tcp} --sport ftp-data -o <iface_A> -i <iface_B> -s <ftp_server> -m state --state RELATED,ESTABLISHED -j ACCEPT`<br><br>`iptables -A FORWARD -p {udp, tcp} --dport ftp-data -i <iface_A> -o iface_B> -d <ftp_server> -m state --state ESTABLISHED -j ACCEPT` | Consentire comunicazioni (richieste e risposte) con un server FTP                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `iptables -A FORWARD -i <iface> -p tcp --dport www -d <webserver> -m state --state NEW,ESTABLISHED -j ACCEPT`<br><br>`iptables -A FORWARD -o <iface> -p tcp --sport www -s <webserver> -m state --state ESTABLISHED -j ACCEPT`                                                                                                                                                                                                                                                                                                                                 | Consentire comunicazioni (richieste e risposte) fra internet e un server web                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `iptables -A FORWARD -p tcp --dport 80 -s <subnet> -d <webserver> -m state --state NEW,ESTABLISHED -j ACCEPT`<br><br>`iptables -A FORWARD -p tcp --sport 80 -s <webserver> -d <subnet> -m state --state ESTABLISHED -j ACCEPT`                                                                                                                                                                                                                                                                                                                                 | Consentire comunicazioni (richieste e risposte) fra una LAN e un server web                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

## NAT

| comando                                                                                                                                                                     | funzione                                           |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| `iptables -t nat -A {PREROUTING, OUTPUT, POSTROUTING} [stesse opzioni di firewalling] -j {SNAT, MASQUERADE, DNAT, REDIRECT} [{--to-source, --to-destination} <ip_address>]` | implementa politica di network address translation |
